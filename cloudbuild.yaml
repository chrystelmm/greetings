steps:
# build image
- id: docker-build
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'build', '-t', 'gcr.io/$PROJECT_ID/greetings:$SHORT_SHA', '.' ]

# tag image with git short_sha
- id: docker-tag
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'tag', 'gcr.io/$PROJECT_ID/greetings:$SHORT_SHA', 'gcr.io/$PROJECT_ID/greetings:latest' ]
  wait_for: ['docker-build']

# test image
- id: test
  name: 'gcr.io/$PROJECT_ID/greetings:$SHORT_SHA'
  args: ['npx', '-v']
  env:
  - 'HOME=/app'
  wait_for: ['docker-tag']

# push image to registry
- id: docker-push
  name: 'gcr.io/cloud-builders/docker'
  args: [ 'push', 'gcr.io/$PROJECT_ID/greetings:$SHORT_SHA' ]
  wait_for: ['test']

# render template for DEV environment
- id: helm-template
  name: 'gcr.io/cloud-builders/helmfile'
  args: [ 'helm', 'version' ]
  env:
  - CLOUDSDK_COMPUTE_REGION=us-west1
  - CLOUDSDK_CONTAINER_CLUSTER=development
  wait_for: ['docker-push']


# deploy to DEV environment
# - name: "gcr.io/cloud-builders/gke-deploy:stable"
#   args:
#   - run
#   - --filename=template.yaml
#   - --location=us-west1
#   - --cluster=development
#   wait_for: ['docker-push']
images:
- 'gcr.io/$PROJECT_ID/greetings:$SHORT_SHA'